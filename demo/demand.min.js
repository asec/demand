/*! Demand - v1.0.0 - 2015-01-31
* https://github.com/asec/demand
* Copyright (c) 2015 Roland Zs√°mboki; Licensed MIT */
!function(){String.prototype.format||(String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})});var a={settings:{_settings:{},set:function(a,b){this._settings[a]=b},get:function(a){return"undefined"!=typeof this._settings[a]?this._settings[a]:null}},lang:{},packages:{},dependencies:{},init:function(){},registerPackage:function(b,c,d,e){if(d&&"[object Array]"===Object.prototype.toString.call(d)&&(e=d,d=null),e=e||[],d=d||"default",!b||!c)return console.error(this.lang.PACKAGE_ERROR_CANTREGISTER),!1;"undefined"==typeof this.packages[b]&&(this.packages[b]={}),"undefined"==typeof this.packages[b][c]&&(this.packages[b][c]={}),"undefined"==typeof this.packages[b][c][d]&&(this.packages[b][c][d]={}),this.packages[b][c][d].loaded=!1,this.packages[b][c][d].loading=!1,this.packages[b][c][d].queue=new a.Queue,this.packages[b][c][d].waiting=[];var f,g,h=b+"."+c+"."+d;this.dependencies[h]=[];for(var i=0;i<e.length;i++)g=e[i].css?"css":"demand",f=e[i].css?e[i].css:e[i].demand,"demand"!==g||f!==h?this.addDependency(h,g,f):console.warn(this.lang.PACKAGE_ERROR_CANTBESELFDEP)},execute:function(b,c,d){if("set"===b)return"string"!=typeof c||"string"!=typeof d?!1:(this.settings.set(c,d),!0);var e=this.parseMarker(b),f=e.packageName,g=e.pack,h=(typeof c).toLowerCase();if("function"!==h&&"undefined"!==h)return console.error(this.lang.EXEC_ERROR_NOTFUNCTION),!1;if("function"===h&&g.queue.add(c),g.loaded)g.queue.execute();else{var i=this.loadPrerequisites(f,g);i||g.loading||this.loadJs(f),a.settings.get("listenerUrl")&&this.flagUsedPackage(f),g.loading=!0}},loadPrerequisites:function(a,b){for(var c=!1,d=0;d<this.dependencies[a].length;d++){var e=this.dependencies[a][d];if("css"!==e.type)if("demand"!==e.type);else{var f=this.parseMarker(e.uri);!f||f.pack.loaded||f.pack.loading||(c=!0,b.waiting.push(f.packageName),demand(e.uri))}else b.loading||this.loadCss(e.uri,a)}return c},loadCss:function(a,b){var c=this.assembleUrl(a,!0,b),d=document.createElement("link");d.rel="stylesheet",d.type="text/css",d.href=c,document.getElementsByTagName("head")[0].appendChild(d)},loadJs:function(a,b){var c=this.assembleUrl(a,b?!0:!1,b),d=document.createElement("script");d.type="text/javascript",d.src=c,d.async=!0,document.getElementsByTagName("head")[0].appendChild(d)},loaded:function(a){var b=this.parseMarker(a);if(!b)return!1;var c=b.pack;if(c.loading||this.loadPrerequisites(b.packageName,c),c.loading=!1,c.loaded)return!0;console.log(this.lang.DOWNLOAD_SUCCESS.format(b.packageName)),c.loaded=!0,demand(b.packageName);for(var d in this.dependencies)if(d!==b.packageName){var e=this.parseMarker(d),f=e.pack.waiting.indexOf(b.packageName);f>-1&&(e.pack.waiting.splice(f,1),e.pack.waiting.length||this.loadJs(d))}},parseMarker:function(a){var b=a.split(".");if(!b[0]||!b[1])return console.error(this.lang.PACKAGE_ERROR_CANTPARSENAME),!1;var c={family:b[0],"package":b[1],subpackage:b[2]||"default"};return"undefined"==typeof this.packages[c.family]||"undefined"==typeof this.packages[c.family][c["package"]]||"undefined"==typeof this.packages[c.family][c["package"]][c.subpackage]?(console.error(this.lang.PACKAGE_ERROR_NOTFOUND.format(c.family+"."+c["package"]+("default"!==c.subpackage?"."+c.subpackage:""))),!1):(c.pack=this.packages[c.family][c["package"]][c.subpackage],c.packageName=c.family+"."+c["package"]+"."+c.subpackage,c)},assembleUrl:function(a,b,c){b=!!b;var d,e=this.settings.get("cdnUrl");return d=b&&c?e+c+"/"+a:e+a+".js"},addDependency:function(a,b,c){var d=this.parseMarker(a),e=d.packageName;return"undefined"==typeof this.dependencies[e]&&(this.dependencies[e]=[]),this.dependencies[e].push({type:b,uri:c}),!0},ajax:{xhr:null,queue:[],doCall:function(a){a={method:a.method.toLowerCase()||"get",error:a.error||null,success:a.success||null,data:a.data||{}},this.queue.push(a),this.execute()},execute:function(){if(!this.queue.length)return!1;if(this.xhr)return!1;var b=this.queue.shift();this.xhr=window.XMLHttpRequest?new XMLHttpRequest:new window.ActiveXObject("Microsoft.XMLHTTP");var c=this.xhr,d=this;this.xhr.onreadystatechange=function(){var a;4===c.readyState&&(200===c.status?(a=(typeof b.success).toLowerCase(),"function"==typeof b.success&&b.success.call(d,c.responseText)):(a=(typeof b.error).toLowerCase(),"function"==typeof b.error&&b.error.call(d,c.responseText)),d.xhr=null,d.execute())};var e=[];for(var f in b.data)e.push(encodeURIComponent(f)+"="+encodeURIComponent(b.data[f]));"post"===b.method?(this.xhr.open(b.method,a.settings.get("listenerUrl"),!0),this.xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),this.xhr.send(e)):(this.xhr.open(b.method,a.settings.get("listenerUrl")+(e.length>0?"?"+e.join("&"):""),!0),this.xhr.send())}},flagUsedPackage:function(a){var b={method:"post",data:{packageName:a},error:function(a){console.log(a)}};this.ajax.doCall(b)}};a.init(),a.Queue=function(){this._queue=[]},a.Queue.prototype.add=function(a){var b=(typeof a).toLowerCase();return"function"!==b?(console.error(this.lang.EXEC_ERROR_NOTFUNCTION),!1):(this._queue.push(a),!0)},a.Queue.prototype.executeNext=function(){if(!this._queue.length)return!1;var a=this._queue.shift();a.call(window)},a.Queue.prototype.execute=function(){for(;this._queue.length;)this.executeNext()},a.lang={PACKAGE_ERROR_CANTREGISTER:"You can't register a demand package without it's family and package name!",PACKAGE_ERROR_CANTPARSENAME:"In order to demand a package you need to address it in the following format: family.package[.subpackage]",PACKAGE_ERROR_NOTFOUND:"The package could not be found: {0}",EXEC_ERROR_NOTFUNCTION:"You can only execute functions on demand.",DOWNLOAD_SUCCESS:"Demanded package successfully loaded: {0}",PACKAGE_ERROR_CANTBESELFDEP:"The package can't have itself as a dependency!"},a.settings.set("cdnUrl","http://asec.github.io/demand/demo/packages/"),a.settings.set("listenerUrl","http://localhost/themes/demand/"),a.registerPackage("jquery","latest"),a.registerPackage("bootstrap","3",[{css:"css/bootstrap.min.css"},{css:"css/bootstrap-theme.min.css"},{demand:"jquery.latest"}]),a.registerPackage("bootstrap","2",[{css:"css/bootstrap.min.css"},{css:"css/bootstrap-responsive.min.css"},{demand:"jquery.latest"}]),a.registerPackage("elux","framework","input",[{demand:"jquery.latest"}]),a.registerPackage("elux","framework","alert"),a.registerPackage("elux","framework","messages",[{demand:"bootstrap.3"}]),a.registerPackage("elux","framework","dialog",[{demand:"bootstrap.3"}]),a.registerPackage("elux","framework",[{demand:"bootstrap.3"}]);var b=function(a,b,c){var d=this.demand.demandObject;return d.execute(a,b,c)};b.demandObject=a,demand=b}();